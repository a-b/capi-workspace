#!/bin/bash -e

export SHEP_LEASE_OUTPUT_JSON=$(shepherd get lease --namespace ${SH_NS:-aberezovsky} ${SH_ID:---last-lease} --json | jq -r '.output' \
| jq --sort-keys "del(.ops_file_content, .ops_manager.private_key)"
)

# echo ${SHEP_LEASE_OUTPUT_JSON:?} | jless


echo "Loading BOSH for ${SH_ID:?}"
time eval "$(smith bosh -l <(echo ${SHEP_LEASE_OUTPUT_JSON:?}))"

export  OM_SKIP_SSL_VALIDATION=true \
         SYS_DOMAIN=$( yq -r '.sys_domain'           <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) \
          OM_TARGET=$( yq -r '.ops_manager.url'      <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) \
        OM_USERNAME=$( yq -r '.ops_manager.username' <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) \
        OM_PASSWORD=$( yq -r '.ops_manager.password' <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) \
TAS_URL_APPS_DOMAIN=$( yq -r '.apps_domain'          <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) \
          SHEP_NAME=$( yq -r '.name'                 <(echo ${SHEP_LEASE_OUTPUT_JSON:?}) ) 
 TAS_ADMIN_PASSWORD=$( credhub get --output-json \
                                   --name "/opsmgr/$(bosh deployments --json | jq -r '.Tables[].Rows[].name')/uaa/admin_credentials" \
                       | jq -r '.value.password') \
        CF_INT_PASSWORD="${TAS_ADMIN_PASSWORD:?}"

       	 # CF_API="api.${SYS_DOMAIN:?}" \
       	 #
echo "Connecting CF CLI..."
time cf login -a "api.${SYS_DOMAIN:?}" \
              -u "admin" \
              -p "${TAS_ADMIN_PASSWORD:?}" \
              --skip-ssl-validation

export SHEP_ENV_CREDENTIALS=$(
echo cf login -a "api.${SYS_DOMAIN:?}" \
              -u "admin" \
              -p "${TAS_ADMIN_PASSWORD:?}" \
              --skip-ssl-validation

echo "http://apps.${SYS_DOMAIN:?}"
echo "http://tas-portal.${SYS_DOMAIN:?}"
echo "http://tas-portal.${TAS_URL_APPS_DOMAIN:?}"
echo -e "login: admin\npassword: ${TAS_ADMIN_PASSWORD:?}"
)

echo "$SHEP_ENV_CREDENTIALS"
echo 'To recall env credentials run: echo $SHEP_ENV_CREDENTIALS'

 [[ $_ != $0 ]] || 
zsh
